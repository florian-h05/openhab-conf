# description: Doorbell widget (designed for DoorBird video doorbells) with live video and speach support (SIP based), as well as light and relay controls, and doorbell pressed and motion state indicators with access the last event's image and timestamp
# note: The widget is updating it's style depending on the screen's dimensions. It's designed to be the only one on a full page!
# dependencies: "doorbellEvent" widget
# author: Copyright (c) 2022 Florian Hotze under MIT License
uid: doorbellPageWidget
tags:
  - doorbell
  - florianh-widgetset
props:
  parameters:
    - context: item
      description: Swicth Item that controls the night vision
      label: Night vision
      name: item_light
      required: true
      type: TEXT
      groupName: doorbellControl
    - context: item
      description: Switch Item that controls the relay to open the door
      label: Door relay
      name: item_doorRelay
      required: true
      type: TEXT
      groupName: doorbellControl
    - context: item
      description: Switch Item that indicates whether the doorbell is currently pressed
      label: Doorbell pressed state
      name: item_doorbellPressed
      required: true
      type: TEXT
      groupName: doorbellPressedState
    - context: item
      description: Image Item that holds the event image when the doorbell was pressed
      label: Doorbell last pressed image
      name: item_buttonLastPressedImage
      required: true
      type: TEXT
      groupName: doorbellPressedState
    - context: item
      description: DateTime Item that holds the timestamp when the doorbell was pressed
      label: Doorbell last pressed timestamp
      name: item_buttonLastPressedTimestamp
      required: true
      type: TEXT
      groupName: doorbellPressedState
    - context: item
      description: Switch Item that indicates whether motion is currently detected
      label: Motion state
      name: item_motion
      required: true
      type: TEXT
      groupName: doorbellMotionState
    - context: item
      description: Image Item that holds the event image when motion was detected
      label: Last motion image
      name: item_lastMotionImage
      required: true
      type: TEXT
      groupName: doorbellMotionState
    - context: item
      description: DateTime Item that holds the timestamp when motion was detected
      label: Last motion timestamp
      name: item_lastMotionTimestamp
      required: true
      type: TEXT
      groupName: doorbellMotionState
    - description: "Full URL of the image providing the liveview (the image is updated several times a second). The image is used, not the MJPEG video stream, because the video stream stops often"
      label: Live image URL
      name: imageUrl
      required: true
      type: TEXT
      groupName: video
    - description: Full URL of the WebRTC SIP websocket, e.g. 'wss://siphost:8089/ws' or relative path, e.g. '/ws', for Android & iOS, you need wss (WebSocket secured)
      label: WebSocket URL
      name: websocketUrl
      required: true
      type: TEXT
      groupName: sipClient
    - description: SIP Domain
      label: Domain
      name: domain
      required: true
      type: TEXT
      groupName: sipClient
    - description: SIP Username
      label: Username
      name: username
      required: true
      type: TEXT
      groupName: sipClient
    - description: SIP Password
      label: Password
      name: password
      required: true
      type: TEXT
      groupName: sipClient
    - description: Single SIP Address (phone number) for a single call target or a comma-separated list of 'phoneNumber=name' for multiple call targets
      label: Phonebook
      name: phonebook
      required: false
      type: TEXT
      groupName: sipClient
    - description: Enable SIP debugging to the console
      label: Enable SIP Debugging
      name: enableSIPDebug
      required: false
      type: BOOLEAN
      groupName: sipClient
      advanced: true
  parameterGroups:
    - name: doorbellControl
      label: Doorbell Control
      description: Configuration for controlling the doorbell and the door
    - name: video
      label: Video Configuration
      description: Configuration of the live video
    - name: sipClient
      label: SIP Client Configuration
      description: Configuration for the SIP client to talk with the doorbell
    - name: doorbellPressedState
      label: Doorbell Pressed State
      description: Configuration related to the doorbell's pressed state
    - name: doorbellMotionState
      label: Doorbell Motion State
      description: Configuration related to the doorbell's motion state
timestamp: Oct 9, 2022, 11:26:23 AM
component: f7-card
config:
  style:
    background-color: "=themeOptions.dark === 'dark' ? 'black' : 'white'"
    border-radius: var(--f7-card-expandable-border-radius)
    height: calc(95vh - var(--f7-navbar-height) - var(--f7-toolbar-height))
    margin: 0px
    box-shadow: 0px 0px 0px 0px rgba(0,0,0,0)
    padding: 0px
    width: 100%
slots:
  default:
    - component: oh-image
      config:
        url: =props.imageUrl
        refreshInterval: 250
        lazy: false
        style:
          margin-left: "=screen.width <= (screen.height * (4/3)) ? '0' : 'calc(calc(100% - calc(96vh - var(--f7-navbar-height) - var(--f7-toolbar-height)) * (4/3)) / 2)'"
          border-radius: var(--f7-card-expandable-border-radius)
          width: "=screen.width <= (screen.height * (4/3)) ? '100%' : 'calc(calc(95vh - var(--f7-navbar-height) - var(--f7-toolbar-height)) * (4/3))'"
    - component: f7-card
      config:
        style:
          background-color: "=themeOptions.dark === 'dark' ? 'black' : 'white'"
          border-radius: var(--f7-card-expandable-border-radius)
          box-shadow: 0px 0px 0px 0px rgba(0,0,0,0)
          height: 330px
          width: 150px
          position: absolute
          top: 5px
          padding: 0px
          left: "=(screen.height * (4/3)) / 2 - 175 >= 160 ? '5px' : 'calc(calc(100% - calc(96vh - var(--f7-navbar-height) - var(--f7-toolbar-height)) * (4/3)) / 2 - 175px)'"
      slots:
        content:
          - component: f7-block
            config:
              style:
                display: flex
                flex-direction: column
                justify-content: between
                position: absolute
                top: 0px
                left: 0px
            slots:
              default:
                - component: f7-block
                  config:
                    style:
                      display: flex
                      flex-direction: row
                      justify-content: between
                      text-align: center
                      margin: 0 0 0 0
                  slots:
                    default:
                      - component: oh-button
                        config:
                          action: popup
                          actionModal: widget:doorbellEvent
                          actionModalConfig:
                            eventDescription: Letztes Klingeln
                            item_eventImage: =props.item_buttonLastPressedImage
                            item_eventTimestamp: =props.item_buttonLastPressedTimestamp
                          iconColor: "=items[props.item_doorbellPressed].state === 'ON' ? (themeOptions.dark === 'dark' ? 'white' : 'black') : 'gray'"
                          iconSize: 40
                          iconF7: "=items[props.item_doorbellPressed].state === 'ON' ? 'bell' : 'bell_slash'"
                          style:
                            --f7-button-height: 40
                      - component: oh-button
                        config:
                          action: popup
                          actionModal: widget:doorbellEvent
                          actionModalConfig:
                            eventDescription: Letzte Bewegung
                            item_eventImage: =props.item_lastMotionImage
                            item_eventTimestamp: =props.item_lastMotionTimestamp
                          iconColor: "=items[props.item_motion].state === 'ON' ? (themeOptions.dark === 'dark' ? 'white' : 'black') : 'gray'"
                          iconSize: 40
                          iconF7: arrow_right_arrow_left
                          style:
                            --f7-button-height: 40
                - component: f7-block
                  config:
                    style:
                      display: flex
                      flex-direction: row
                      justify-content: between
                      text-align: center
                      margin-top: 20px
                      margin-left: 18px
                  slots:
                    default:
                      - component: oh-button
                        config:
                          action: command
                          actionCommand: ON
                          actionItem: =props.item_light
                          iconF7: lightbulb_fill
                          iconSize: 60
                          style:
                            --f7-button-height: 60
                - component: f7-block
                  config:
                    style:
                      display: flex
                      flex-direction: row
                      justify-content: between
                      text-align: center
                      margin-top: 20px
                  slots:
                    default:
                      - component: oh-sipclient
                        config:
                          enableTones: false
                          enableVideo: false
                          iconSize: 90
                          hideCallerId: true
                          websocketUrl: =props.websocketUrl
                          domain: =props.domain
                          username: =props.username
                          password: =props.password
                          phonebook: =props.phonebook
                          enableSIPDebug: =props.enableSIPDebug
                - component: f7-block
                  config:
                    style:
                      display: flex
                      flex-direction: row
                      justify-content: between
                      text-align: center
                      margin-top: 10px
                      margin-left: 20px
                  slots:
                    default:
                      - component: oh-button
                        config:
                          action: options
                          actionItem: =props.item_doorRelay
                          actionOptions: ON=Tür öffnen
                          iconF7: lock_open_fill
                          iconSize: 60
                          style:
                            --f7-button-height: 60
